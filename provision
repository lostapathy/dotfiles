#!/bin/bash
set -e # fail fast

# This may not actually be a great idea with servers?
UBUNTU_VERSION=`lsb_release -r | awk '{print $2}'`
if [ "$UBUNTU_VERSION" != "21.04" ] ; then
  echo "Not on correct ubuntu version for this script, exiting"
  exit
fi

# We need these commands to exist in order to proceed.
# See README.md
commands=(git ansible-playbook rcup)
for cmd in "${commands[@]}"; do
  command -v "$cmd" > /dev/null || { echo "ERROR: command not found: ${cmd}" ; exit 1; }
done

# Update dotfiles with rcm.
rcup -v

if [ -f ~/.dotfilesrc ]; then
  # shellcheck disable=SC1090
  . "${HOME}/.dotfilesrc"
else
  echo "ERROR: no ~/.dotfilesrc, run ./setup first"
  exit
fi

# Figure out what ansible playbooks, if any, to run
playbooks=()
# Need to add a flag for this
playbooks+=("provisioning/core.yml")
if [ "${DOTFILES_GUI}" == "y" ]; then
  playbooks+=("provisioning/desktop.yml")
  playbooks+=("provisioning/graphic-design.yml")
fi

if [ "${DOTFILES_DEV}" == "y"  ]; then
  playbooks+=("provisioning/development.yml")
fi

if [ ${#playbooks[@]} -gt 0 ]; then
  PATH=/usr/bin:/bin ansible-playbook --ask-become-pass -e ansible_python_interpreter=/usr/bin/python3 \
    $(IFS=" " ;echo "${playbooks[*]}")
fi

# Install asdf plugins
set +e # Disabling errors is a hack to get around this command failing when all plugins are installed
# make sure plugin is installed
awk '{print $1}' ~/.tool-versions | xargs -L1 asdf plugin-add
# Make sure it's got latest defs
awk '{print $1}' ~/.tool-versions | xargs -L1 asdf plugin-update
set -e

asdf install
