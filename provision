#!/bin/bash
set -e # fail fast

# Detect distro
if [ -f /etc/os-release ]; then
  . /etc/os-release
  DISTRO="$ID"
else
  echo "ERROR: Cannot detect distribution"
  exit 1
fi

# Validate supported distro/version
case "$DISTRO" in
  ubuntu)
    if [ "$VERSION_ID" != "24.04" ] && [ "$VERSION_ID" != "22.04" ]; then
      echo "ERROR: Unsupported Ubuntu version: $VERSION_ID (need 22.04 or 24.04)"
      exit 1
    fi
    ;;
  fedora)
    if [ "$VERSION_ID" -lt 43 ]; then
      echo "ERROR: Unsupported Fedora version: $VERSION_ID (need 43 or newer)"
      exit 1
    fi
    ;;
  debian)
    # Accept any Debian version for now
    ;;
  *)
    echo "ERROR: Unsupported distro: $DISTRO"
    exit 1
    ;;
esac

# We need these commands to exist in order to proceed.
# See README.md
commands=(git ansible-playbook ansible-galaxy rcup)
for cmd in "${commands[@]}"; do
  command -v "$cmd" > /dev/null || { echo "ERROR: command not found: ${cmd}" ; exit 1; }
done

# Update dotfiles with rcm.
rcup -v

if [ -f ~/.dotfilesrc ]; then
  # shellcheck disable=SC1090
  . "${HOME}/.dotfilesrc"
else
  echo "ERROR: no ~/.dotfilesrc, run ./setup first"
  exit
fi

# Figure out what ansible playbooks, if any, to run
playbooks=()
# Need to add a flag for this
playbooks+=("provisioning/core.yml")
if [ "${DOTFILES_GUI}" == "y" ]; then
  playbooks+=("provisioning/desktop.yml")
  playbooks+=("provisioning/graphic-design.yml")
fi

if [ "${DOTFILES_DEV}" == "y"  ]; then
  playbooks+=("provisioning/development.yml")
fi

if [ ${#playbooks[@]} -gt 0 ]; then
  PATH=/usr/bin:/bin ansible-playbook --ask-become-pass -e ansible_python_interpreter=/usr/bin/python3 \
    $(IFS=" " ;echo "${playbooks[*]}")
fi

# Install global gems.  Had errors on first attempt of moving this into core.yml
# Add asdf binary and shims to PATH (ruby/bundle may have just been installed)
export PATH="$HOME/.local/bin:$HOME/.asdf/shims:$PATH"
bundle install

# if [ "${DOTFILES_GUI}" == "y"  ]; then
#   npm install -g nativefier
#   if [ -f ~/software/glowing-bear-linux-x64 ]; then
#     nativefier --upgrade ~/software/glowing-bear-linux-x64
#   else
#     nativefier https://glowing-bear.org/ ~/software/ -n glowing-bear
#   fi
# fi
